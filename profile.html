<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROSES • Profil</title>
  <style>
    :root {
      /* Branding: Merah • Putih • Biru • Hijau */
      --red:  #dc2626;
      --blue: #2563eb;
      --green:#16a34a;
      --white:#ffffff;

      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 10px 28px rgba(0,0,0,.08);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background:
        radial-gradient(1100px 520px at 15% 0%, rgba(37,99,235,.10) 0%, transparent 55%),
        radial-gradient(850px 480px at 92% 8%, rgba(220,38,38,.10) 0%, transparent 55%),
        radial-gradient(900px 520px at 60% 100%, rgba(22,163,74,.10) 0%, transparent 55%),
        var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
    }
    .wrap { min-height: 100vh; display:grid; place-items:center; padding: 22px 14px; }
    .card {
      width: 100%;
      max-width: 980px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .top {
      padding: 18px 18px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
      flex-wrap: wrap;
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%);
      position: relative;
    }
    .ribbon {
      position:absolute; inset:0 0 auto 0;
      height: 6px;
      background: linear-gradient(90deg, var(--red), var(--white), var(--blue), var(--green));
    }
    .brand { display:flex; align-items:center; gap:12px; padding-top: 6px; }
    .logoWrap {
      width: 42px; height: 42px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      display:grid;
      place-items:center;
      overflow:hidden;
      box-shadow: 0 8px 18px rgba(17,24,39,.10);
      flex: 0 0 auto;
    }
    .logoWrap img { width:100%; height:100%; object-fit:cover; display:block; }
    .logoFallback {
      width:100%; height:100%;
      display:grid; place-items:center;
      font-weight: 900;
      color: #111827;
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(220,38,38,.10));
    }
    h1 { margin: 0; font-size: 18px; }
    .sub { margin: 4px 0 0; color: var(--muted); font-size: 13px; }
    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background:#111827;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
    }
    .btn.secondary { background:#fff; color:#111827; }
    .btn.danger { background:#fff; color:#b91c1c; border-color:#fecaca; }
    .btn.primary { background: linear-gradient(90deg, var(--blue), var(--green)); border: 0; }
    .btn:active { transform: translateY(1px); }
    .body {
      padding: 16px 18px 20px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 920px) { .body { grid-template-columns: 1fr; } }
    .panel { border:1px solid var(--border); border-radius: 16px; padding: 14px; background:#fff; }
    .row { display:flex; gap: 14px; align-items:center; flex-wrap:wrap; }
    .avatar {
      width: 78px; height: 78px;
      border-radius: 999px;
      background:#f3f4f6;
      border: 1px solid var(--border);
      display:grid; place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
      font-weight: 900;
      color:#374151;
      font-size: 22px;
    }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }
    .k { color: var(--muted); font-size: 12px; margin-top: 10px; }
    .v { font-weight: 800; margin-top: 2px; word-break: break-word; }
    input, textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    input:focus, textarea:focus {
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }
    textarea { min-height: 96px; resize: vertical; }
    .muted { color: var(--muted); font-size: 13px; line-height: 1.45; margin-top: 10px; }
    .hide { display:none !important; }
    code {
      background:#f3f4f6;
      border:1px solid var(--border);
      padding: 2px 6px;
      border-radius: 8px;
    }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background:#fff;
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }
    .dot { width: 8px; height: 8px; border-radius: 999px; background: var(--green); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="ribbon"></div>
        <div class="brand">
          <div class="logoWrap">
            <img src="./logo.png" alt="Logo Sekolah" onerror="this.remove(); document.getElementById('logoFallback').style.display='grid';">
            <div id="logoFallback" class="logoFallback" style="display:none;">RO</div>
          </div>
          <div>
            <h1>Profil Guru</h1>
            <div class="sub">Semak profil & teruskan ke ROSES.</div>
            <span class="pill" title="Tarikh/masa login terakhir"><span class="dot"></span><span id="lastLoginText">Belum login</span></span>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; padding-top: 6px;">
          <a class="btn secondary" href="./index.html">Kembali</a>
          <button class="btn danger" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="body">
        <div class="panel">
          <div class="row">
            <div class="avatar" id="avatarBox">?</div>
            <div style="min-width: 220px;">
              <div class="k">Nama</div>
              <div class="v" id="nameVal">-</div>
              <div class="k">Email</div>
              <div class="v" id="emailVal">-</div>
            </div>
          </div>

          <div class="muted" id="loginHint">
            Klik <b>Login</b> di halaman sebelumnya jika anda belum log masuk.
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px;">
            <button class="btn primary" id="btnContinue" onclick="continueToRoses()">Teruskan ke ROSES</button>
            <button class="btn secondary" onclick="copyEmbed()">Salin kod embed</button>
          </div>
        </div>

        <div class="panel">
          <div class="k">URL Web App ROSES (exec)</div>
          <input id="webapp" />
          <div class="muted">
            Jika anda buat <i>new deployment</i>, tampal URL baru di sini. Ia akan disimpan untuk kegunaan akan datang.
          </div>

          <div class="k" style="margin-top: 14px;">Kod embed (untuk Google Sites)</div>
          <textarea id="embedCode" readonly></textarea>
        </div>
      </div>
    </div>
  </div>

<script>
function b64UrlToJson(b64url){
  try{
    const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
    const json = decodeURIComponent(atob(b64).split('').map(c => '%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(json);
  }catch(e){ return null; }
}
function decodeJwt(token){
  if(!token) return null;
  const parts = token.split('.');
  if(parts.length < 2) return null;
  return b64UrlToJson(parts[1]);
}
function setWebAppUrl(url){
  try{ localStorage.setItem("ROSES_WEBAPP_URL", url || ""); }catch(e){}
}
function getWebAppUrl(){
  try{ return (localStorage.getItem("ROSES_WEBAPP_URL") || "").trim(); }catch(e){ return ""; }
}
function getRememberMe(){
  try{ return (localStorage.getItem("ROSES_REMEMBER") || "1") === "1"; }catch(e){ return true; }
}
function setLastLoginNow(){
  try{ localStorage.setItem("ROSES_LAST_LOGIN", new Date().toISOString()); }catch(e){}
}
function getLastLogin(){
  try{ return (localStorage.getItem("ROSES_LAST_LOGIN") || "").trim(); }catch(e){ return ""; }
}
function fmtMsIso(iso){
  if(!iso) return "";
  try{
    const d = new Date(iso);
    const pad = n => (n<10? "0"+n : ""+n);
    return pad(d.getDate()) + "/" + pad(d.getMonth()+1) + "/" + d.getFullYear()
      + " " + pad(d.getHours()) + ":" + pad(d.getMinutes());
  }catch(e){ return ""; }
}
function getToken(){
  try{
    const remember = getRememberMe();
    return (remember ? (localStorage.getItem("ROSES_ID_TOKEN")||"") : (sessionStorage.getItem("ROSES_ID_TOKEN")||"")).trim();
  }catch(e){ return ""; }
}
function clearToken(){
  try{ localStorage.removeItem("ROSES_ID_TOKEN"); }catch(e){}
  try{ sessionStorage.removeItem("ROSES_ID_TOKEN"); }catch(e){}
}

function refreshEmbed(){
  const url = (document.getElementById("webapp").value || "").trim();
  const code = '<iframe src="' + url + '" style="width:100%;height:920px;border:0;border-radius:14px;" loading="lazy"></iframe>';
  document.getElementById("embedCode").value = code;
}

function renderProfile(){
  var ll = fmtMsIso(getLastLogin());
  document.getElementById("lastLoginText").textContent = ll || "Belum login";

  const webapp = document.getElementById("webapp");
  webapp.value = getWebAppUrl() || "https://script.google.com/macros/s/AKfycbw2SESSgVwauvEzzOXA144jg3LIE9DHQ5kVYYcFfNwP09SWFS-0z9C7wthI8tF7Xwlo7g/exec";
  webapp.addEventListener("input", () => {
    setWebAppUrl(webapp.value.trim());
    refreshEmbed();
  });
  refreshEmbed();

  const token = getToken();
  const payload = decodeJwt(token);

  const nameEl = document.getElementById("nameVal");
  const emailEl = document.getElementById("emailVal");
  const avatar = document.getElementById("avatarBox");
  const hint = document.getElementById("loginHint");
  const btn = document.getElementById("btnContinue");

  if(!payload){
    nameEl.textContent = "-";
    emailEl.textContent = "-";
    avatar.textContent = "?";
    hint.classList.remove("hide");
    btn.disabled = true;
    btn.style.opacity = .6;
    return;
  }

  const name = (payload.name || payload.given_name || "").trim();
  const email = (payload.email || "").trim();
  const pic = (payload.picture || "").trim();

  nameEl.textContent = name || "(Tiada nama)";
  emailEl.textContent = email || "(Tiada email)";
  hint.classList.add("hide");
  btn.disabled = false;
  btn.style.opacity = 1;

  const initial = (name || email || "?").slice(0,1).toUpperCase();
  if(pic){
    avatar.innerHTML = '<img alt="Profil" src="' + pic + '" referrerpolicy="no-referrer" onerror="this.remove(); document.getElementById(\'avatarBox\').textContent=\'' + initial + '\';" />';
    avatar.textContent = initial;
  } else {
    avatar.textContent = initial;
  }
}

function continueToRoses(){
  const token = getToken();
  if(!token) return alert("Sila login dahulu.");
  const url = (document.getElementById("webapp").value || "").trim();
  if(!url) return alert("Sila isi URL Web App ROSES.");
  setWebAppUrl(url);
  setLastLoginNow();
  const next = url.replace(/\?.*$/, "") + "?id_token=" + encodeURIComponent(token);
  window.location.href = next;
}

function copyEmbed(){
  const txt = document.getElementById("embedCode").value;
  navigator.clipboard.writeText(txt).then(() => alert("Kod embed disalin."), () => alert("Tak dapat salin. Sila copy manual."));
}

function logout(){
  clearToken();
  alert("Logout berjaya.");
  renderProfile();
}

window.addEventListener("DOMContentLoaded", renderProfile);
</script>
</body>
</html>
